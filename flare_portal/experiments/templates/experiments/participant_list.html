{% extends "base.html" %}

{% load experiments_tags widget_tweaks %}

{% block title %}Participants - {{ experiment.name }}{% endblock title %}

{% block content %}
    {% with formset=form %}
        <div class="container">
            <div class="row">
                <div class="col-lg-4">
                    {% include "experiments/includes/experiment_sidebar.html" %}
                </div>
                <div class="col-lg-8">
                    <form class="card" method="POST" action="" x-data="{ forms: [], startIndex: {{ formset.management_form.TOTAL_FORMS.value }} }">
                        {% csrf_token %}
                        {{ formset.management_form.TOTAL_FORMS|attr:"x-bind::value:startIndex + forms.length" }}
                        {{ formset.management_form.INITIAL_FORMS }}
                        {{ formset.management_form.MIN_NUM_FORMS }}
                        {{ formset.management_form.MAX_NUM_FORMS }}

                        <div class="card-header">
                            <div class="d-flex align-items-baseline">
                                <h3 class="card-title">Participants</h3>
                                <p class="card-subtitle m-0 ml-2">{{ participants|length }} participant{{ participants|length|pluralize }}</p>
                            </div>
                            <div class="card-options">
                                <a href="{% url "experiments:participant_upload" project_pk=view.kwargs.project_pk experiment_pk=view.kwargs.experiment_pk %}" class="btn btn-sm btn-secondary">
                                    Upload
                                </a>
                                <a href="{% url "experiments:participant_create_batch" project_pk=view.kwargs.project_pk experiment_pk=view.kwargs.experiment_pk %}" class="btn btn-sm btn-secondary ml-4">
                                    Generate batch
                                </a>
                                <button class="btn btn-sm btn-primary ml-4" type="submit">Save changes</button>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table card-table table-vcenter">
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th>Login ID</th>
                                        <th>Started</th>
                                        <th>Finished</th>
                                        <th>Agreed to T&amp;Cs</th>
                                        <th></th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for form in formset %}
                                        <tr>
                                            <td><span class="text-muted">{{ forloop.counter }}</span></td>
                                            <td>
                                                {% if form.non_field_errors %}
                                                    {% for error in form.non_field_errors %}
                                                        <div class="text-danger small mb-2">{{ error }}</div>
                                                    {% endfor %}
                                                {% endif %}

                                                {% if form.instance.pk %}
                                                    {{ form.participant_id|add_class:"form-control"|add_error_class:"is-invalid" }}
                                                {% else %}
                                                    {{ form.participant_id|add_class:"form-control"|add_error_class:"is-invalid"|attr:"placeholder:New participant" }}
                                                {% endif %}

                                                {% for error in form.participant_id.errors %}
                                                    <div class="invalid-feedback">{{ error }}</div>
                                                {% endfor %}
                                            </td>
                                            <td>{{ form.instance.started_at|default:"" }}</td>
                                            <td>{{ form.instance.finished_at|default:"" }}</td>

                                            <td>
                                                <span class="status-icon {% if form.instance.agreed_to_terms_and_conditions %}bg-success{% else %}bg-danger{% endif %}"></span> {{ form.instance.agreed_to_terms_and_conditions|yesno|title }}
                                            </td>

                                            <td>
                                                <a href="{% url 'experiments:participant_delete' project_pk=view.kwargs.project_pk experiment_pk=view.kwargs.experiment_pk participant_pk=form.instance.pk %}">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><line x1="4" y1="7" x2="20" y2="7" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /><path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" /><path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" /></svg>
                                                </a>
                                            </td>
                                            <td>
                                                <div class="dropdown">
                                                    <button type="button" class="btn btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown">
                                                        View data
                                                    </button>
                                                    <div class="dropdown-menu">
                                                        {% get_module_data_types as data_types %}
                                                        {% for data_type in data_types %}
                                                            <a class="dropdown-item" href="{% get_data_list_url data_type %}?participant={{ form.instance.participant_id }}">{{ data_type.get_module_name|capfirst }}</a>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                            </td>

                                        </tr>
                                    {% endfor %}
                                    <template x-for="(form, index) in forms" :key="index">
                                        <tr>
                                            <td><span class="text-muted" x-text="index + startIndex + 1"></span></td>
                                            <td>
                                                <input type="text" :name="`participants-${index + startIndex}-participant_id`" maxlength="24" placeholder="New participant" class="form-control" :id="`id_participants-${index + startIndex}-participant_id`" x-model="forms[index]">
                                            </td>
                                            <td></td>
                                            <td>
                                                <a class="icon" href="#" @click.prevent="forms.splice(index, 1)"><i class="fe fe-trash text-danger"></i></a>
                                                <input type="hidden" :name="`participants-${index + startIndex}-id`" :id="`id_participants-${index + startIndex}-id`">
                                                <input type="hidden" :name="`participants-${index + startIndex}-experiment`" value="{{ experiment.pk }}" :id="`id_participants-${index + startIndex}-experiment`">
                                            </td>
                                            <td></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>

                        <div class="card-footer d-flex">
                            <button class="btn btn-sm btn-secondary" @click.prevent="forms.push('')">Add more participants</button>
                            <button class="btn btn-sm btn-primary ml-auto" type="submit">Save changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    {% endwith %}
{% endblock content %}
